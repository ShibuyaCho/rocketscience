<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brain Candy</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .popup {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .popup-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .quantity-input {
      width: 60px;
    }
  </style>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      emailjs.init("4Nay5tc4PcpTV9k4Q");
    })();
  </script>
</head>
<body>
  <header>
    <div class="container">
      <h1>Brain Candy</h1>
      <p>Exotic Cannabis Full-Gram All-in-Ones - Taste the Quality</p>
    </div>
  </header>

  <main>
    <div id="cart-icon" onclick="toggleCart(event)">
      ðŸ›’ <span id="cart-count">0</span>
    </div>
    <div id="cart-details" style="display: none;">
      <h2>Your Cart</h2>
      <ul id="cart"></ul>
      <div id="cart-subtotal"></div>
      <button onclick="placeOrder()">Place an Order</button>
      <div class="farm-buttons">
        <button onclick="location.href='index.html'">Back to Main Menu</button>
      </div>
    </div>

    <section class="farm-details">
      <div class="container">
        <h2>Available Cart Strains</h2>
        <ul class="strain-list">
          <li class="strain-item" onclick="addToCart('Project Gary', 'N/A', '16')">
            <div><strong>Strain: Project Gary<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Super Runtz', 'N/A', '16')">
            <div><strong>Strain: Super Runtz<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Rainbow Runtz', 'N/A', '16')">
            <div><strong>Strain: Rainbow Runtz<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Black Patronus', 'N/A', '16')">
            <div><strong>Strain: Black Patronus<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Glitter Bomb', 'N/A', '16')">
            <div><strong>Strain: Glitter Bomb<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Prime Time', 'N/A', '16')">
            <div><strong>Strain: Prime Time<br>Price: $16/unit</strong></div>
          </li>
          <li class="strain-item" onclick="addToCart('Grapricot', 'N/A', '16')">
            <div><strong>Strain: Grapricot<br>Price: $16/unit</strong></div>
          </li>
        </ul>
      </div>
    </section>
  </main>

  <div id="orderFormPopup" class="popup">
    <div class="popup-content">
      <span class="close" onclick="closeOrderForm()">&times;</span>
      <h2>Confirm Your Order</h2>
      <div id="orderItemsContainer"></div>
      <textarea id="orderNotes" placeholder="Add any additional notes for your order here" rows="4" cols="50"></textarea>
      <input type="email" id="customerEmail" placeholder="Enter your email address" required>
      <button onclick="submitOrder()">Confirm Order</button>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2024 Rocket Science. All rights reserved.</p>
    </div>
  </footer>
  
<script>
  let cart = [];

  function toggleCart(event) {
    event.stopPropagation();
    const cartDetails = document.getElementById('cart-details');
    cartDetails.style.display = cartDetails.style.display === 'none' ? 'block' : 'none';
  }

  function updateCart() {
    const cartElement = document.getElementById('cart');
    const cartCount = document.getElementById('cart-count');
    cartElement.innerHTML = '';
    let totalItems = 0;
    let subtotal = 0;
    cart.forEach((item, index) => {
      const li = document.createElement('li');
      const itemSubtotal = item.price * item.quantity;
      li.innerHTML = `
        ${item.strain} - $${item.price}/unit x${item.quantity} unit(s)
        <br>Subtotal: $${itemSubtotal.toFixed(2)}
        <button onclick="removeFromCart(${index})">Remove</button>
      `;
      cartElement.appendChild(li);
      totalItems += item.quantity;
      subtotal += itemSubtotal;
    });
    cartCount.textContent = totalItems;
    document.getElementById('cart-subtotal').innerHTML = `<strong>Total: $${subtotal.toFixed(2)}</strong>`;
  }

  function addToCart(strain, thc, price) {
    const existingItem = cart.find(item => item.strain === strain);
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cart.push({ strain, thc, price: parseFloat(price), quantity: 1 });
    }
    updateCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
  }

  function placeOrder() {
    const orderItemsContainer = document.getElementById('orderItemsContainer');
    orderItemsContainer.innerHTML = '';

    cart.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.innerHTML = `
        <p>${item.strain} - $${item.price}/unit</p>
        <input type="number" class="quantity-input" value="${item.quantity}" 
               min="1" step="1" onchange="updateQuantity(${index}, this.value)">
        <span>Subtotal: $${(item.price * item.quantity).toFixed(2)}</span>
      `;
      orderItemsContainer.appendChild(itemDiv);
    });

    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const subtotalDiv = document.createElement('div');
    subtotalDiv.innerHTML = `<strong>Total: $${subtotal.toFixed(2)}</strong>`;
    orderItemsContainer.appendChild(subtotalDiv);

    document.getElementById('orderFormPopup').style.display = 'block';
  }

  function updateQuantity(index, newQuantity) {
    const parsedQuantity = parseInt(newQuantity);
    if (parsedQuantity < 1) {
      alert('Quantity must be at least 1.');
      placeOrder();
      return;
    }
    cart[index].quantity = parsedQuantity;
    updateCart();
    placeOrder();
  }

  function closeOrderForm() {
    document.getElementById('orderFormPopup').style.display = 'none';
  }

  function submitOrder() {
    const notes = document.getElementById('orderNotes').value;
    const customerEmail = document.getElementById('customerEmail').value;
    const farmName = document.querySelector('header h1').textContent;

    if (!customerEmail) {
      alert('Please enter your email address.');
      return;
    }

    let formattedOrderDetails = "Order Details:\n\n";
    
    cart.forEach(item => {
      formattedOrderDetails += `${item.strain} - $${item.price}/unit\n`;
      formattedOrderDetails += `Quantity: ${item.quantity} unit(s)\n`;
      formattedOrderDetails += `Subtotal: $${(item.price * item.quantity).toFixed(2)}\n\n`;
    });

    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    formattedOrderDetails += `Total: $${total.toFixed(2)}\n\n`;

    if (notes) {
      formattedOrderDetails += `Additional Notes:\n${notes}\n`;
    }

    const templateParams = {
      from_email: customerEmail,
      message: formattedOrderDetails,
      farm_name: farmName,
      recipient: 'dinofreud@gmail.com'
    };

    console.log('Sending email with params:', templateParams);

    emailjs.send('service_k67bf2e', 'template_1hz0yfr', templateParams)
      .then(function(response) {
        console.log('SUCCESS!', response.status, response.text);
        alert('Order submitted successfully!');
        cart = [];
        updateCart();
        closeOrderForm();
      }, function(error) {
        console.log('FAILED...', error);
        alert('Failed to submit order. Please try again.');
      });
  }

  document.addEventListener('click', function(event) {
    const cartDetails = document.getElementById('cart-details');
    const cartIcon = document.getElementById('cart-icon');

    if (!cartDetails.contains(event.target) && !cartIcon.contains(event.target)) {
      cartDetails.style.display = 'none';
    }
  });

  document.getElementById('cart-details').addEventListener('click', function(event) {
    event.stopPropagation();
  });
</script>
</body>
</html>